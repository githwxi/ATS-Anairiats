/*
**
** The C code is generated by ATS/Anairiats
** The compilation time is: 2016-8-25: 20h:18m
**
*/

/* include some .h files */
#ifndef _ATS_HEADER_NONE
#include "ats_config.h"
#include "ats_basics.h"
#include "ats_types.h"
#include "ats_exception.h"
#include "ats_memory.h"
#endif /* _ATS_HEADER_NONE */

/* include some .cats files */
#ifndef _ATS_PRELUDE_NONE
#include "prelude/CATS/basics.cats"
#include "prelude/CATS/bool.cats"
#include "prelude/CATS/char.cats"
#include "prelude/CATS/byte.cats"
#include "prelude/CATS/float.cats"
#include "prelude/CATS/integer.cats"
#include "prelude/CATS/integer_ptr.cats"
#include "prelude/CATS/integer_fixed.cats"
#include "prelude/CATS/sizetype.cats"
#include "prelude/CATS/pointer.cats"
#include "prelude/CATS/reference.cats"
#include "prelude/CATS/string.cats"
#include "prelude/CATS/lazy.cats"
#include "prelude/CATS/lazy_vt.cats"
#include "prelude/CATS/printf.cats"
#include "prelude/CATS/list.cats"
#include "prelude/CATS/option.cats"
#include "prelude/CATS/array.cats"
#include "prelude/CATS/matrix.cats"
#endif /* _ATS_PRELUDE_NONE */
/* prologues from statically loaded files */
/* external codes at top */

//
#include "libc/CATS/stdio.cats" // for IO funs
/*
#include "libc/CATS/stdlib.cats" // for [strtol]
*/
extern
long int
strtol(const char *nptr, char **endptr, int base);
//

static inline
ats_int_type
ats_int_of_lint (ats_lint_type i) { return i ; }

/* type definitions */
typedef
struct {
ats_int_type atslab_line ;
ats_int_type atslab_loff ;
ats_lint_type atslab_toff ;
} anairiats_rec_0 ;

typedef
struct {
ats_clo_ref_type atslab_free ;
ats_clo_ref_type atslab_getc ;
} anairiats_rec_1 ;

/* external typedefs */
/* external dynamic constructor declarations */
ATSextern_val(ats_exn_type, ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__LexingErrorException) ;

/* external dynamic constant declarations */
ATSextern_fun(ats_ptr_type, atspre_stdout_get) () ;
ATSextern_fun(ats_void_type, atspre_stdout_view_set) () ;
ATSextern_fun(ats_ptr_type, atspre_stderr_get) () ;
ATSextern_fun(ats_void_type, atspre_stderr_view_set) () ;
ATSextern_fun(ats_int_type, atspre_int_of_char) (ats_char_type) ;
ATSextern_fun(ats_int_type, atspre_add_int_int) (ats_int_type, ats_int_type) ;
ATSextern_fun(ats_bool_type, atspre_gt_int_int) (ats_int_type, ats_int_type) ;
ATSextern_fun(ats_lint_type, atspre_add_lint_lint) (ats_lint_type, ats_lint_type) ;
ATSextern_fun(ats_bool_type, atspre_lt_lint_lint) (ats_lint_type, ats_lint_type) ;
ATSextern_fun(ats_bool_type, atspre_lte_lint_lint) (ats_lint_type, ats_lint_type) ;
ATSextern_fun(ats_bool_type, atspre_eq_lint_lint) (ats_lint_type, ats_lint_type) ;
ATSextern_fun(ats_bool_type, atspre_neq_lint_lint) (ats_lint_type, ats_lint_type) ;
ATSextern_fun(ats_size_type, atspre_size1_of_int1) (ats_int_type) ;
ATSextern_fun(ats_size_type, atspre_add_size1_int1) (ats_size_type, ats_int_type) ;
ATSextern_fun(ats_bool_type, atspre_lt_size1_size1) (ats_size_type, ats_size_type) ;
ATSextern_fun(ats_ptr_type, atspre_ptr_alloc_tsz) (ats_size_type) ;
ATSextern_fun(ats_void_type, atspre_ptr_free) (ats_ptr_type) ;
ATSextern_fun(ats_char_type, atspre_string_get_char_at) (ats_ptr_type, ats_size_type) ;
ATSextern_fun(ats_size_type, atspre_string_length) (ats_ptr_type) ;
ATSextern_fun(ats_void_type, atspre_fprintf_exn) (ats_ref_type, ats_ptr_type, ...) ;
ATSextern_fun(ats_int_type, ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__accept_table_get) (ats_ptr_type, ats_int_type) ;
ATSextern_fun(ats_int_type, ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__transition_table_get) (ats_ptr_type, ats_int_type, ats_int_type) ;
ATSextern_fun(ats_void_type, ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__fprint_position) (ats_ref_type, ats_ptr_type) ;
ATSextern_fun(ats_void_type, lexbuf_fstpos_set) (ats_ref_type) ;
ATSextern_fun(ats_void_type, lexbuf_lstpos_set) (ats_ref_type) ;
ATSextern_fun(ats_void_type, lexbuf_curpos_set) (ats_ref_type) ;
ATSextern_fun(ats_int_type, lexbuf_char_next) (ats_ref_type) ;
ATSextern_fun(ats_bool_type, lexbuf_is_eof) (ats_ref_type) ;
ATSextern_fun(ats_int_type, lexing_engine_lexbuf) (ats_ref_type, ats_ptr_type, ats_ptr_type) ;
ATSextern_fun(ats_ptr_type, lexing_lexbuf_get) () ;
ATSextern_fun(ats_void_type, lexing_lexbuf_set) (ats_ptr_type) ;
ATSextern_fun(ats_char_type, lexeme_get_lexbuf) (ats_ref_type, ats_int_type) ;
ATSextern_fun(ats_void_type, lexeme_set_lexbuf) (ats_ref_type, ats_int_type, ats_char_type) ;
ATSextern_fun(ats_ptr_type, lexeme_string_lexbuf) (ats_ref_type) ;
ATSextern_fun(ats_lint_type, lexeme_lint_lexbuf) (ats_ref_type, ats_int_type) ;
ATSextern_fun(ats_lint_type, lexeme_lint) (ats_int_type) ;
ATSextern_fun(ats_ptr_type, position_make_int_int_lint) (ats_int_type, ats_int_type, ats_lint_type) ;
ATSextern_fun(ats_void_type, atslib_fclose_exn) (ats_ptr_type) ;
ATSextern_fun(ats_int_type, atslib_getchar) () ;
ATSextern_fun(ats_int_type, ats_int_of_lint) (ats_lint_type) ;
ATSextern_fun(ats_void_type, lexing_lexbuf_markroot) () ;

/* external dynamic terminating constant declarations */
#ifdef _ATS_PROOFCHECK
extern
ats_void_type ATS_2d0_2e2_2e12_2prelude_2basics_dyn_2esats__file_mode_lte_w_w_prfck () ;
#endif /* _ATS_PROOFCHECK */

/* assuming abstract types */
int ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__sasp__infile_t = 0 ;
int ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__sasp__position_t = 0 ;

/* sum constructor declarations */
/* exn constructor declarations */
/* global dynamic (non-functional) constant declarations */
/* internal function declarations */
static
ats_void_type _free_14 (ats_ptr_type env0) ;
static
ats_clo_ptr_type _free_14_closure_make (ats_ptr_type env0) ;
static
ats_void_type _free_14_clofun (ats_clo_ptr_type cloptr) ;
static
ats_int_type _getc_15 (ats_ptr_type env0, ats_size_type env1, ats_ptr_type env2) ;
static
ats_clo_ptr_type _getc_15_closure_make (ats_ptr_type env0, ats_size_type env1, ats_ptr_type env2) ;
static
ats_int_type _getc_15_clofun (ats_clo_ptr_type cloptr) ;
static
ats_void_type _free_17 (ats_ptr_type env0) ;
static
ats_clo_ptr_type _free_17_closure_make (ats_ptr_type env0) ;
static
ats_void_type _free_17_clofun (ats_clo_ptr_type cloptr) ;
static
ats_int_type _getc_18 (ats_ptr_type env0) ;
static
ats_clo_ptr_type _getc_18_closure_make (ats_ptr_type env0) ;
static
ats_int_type _getc_18_clofun (ats_clo_ptr_type cloptr) ;
static
ats_void_type _free_20 () ;
static
ats_clo_ptr_type _free_20_closure_make () ;
static
ats_void_type _free_20_clofun (ats_clo_ptr_type cloptr) ;
static
ats_int_type _getc_21 () ;
static
ats_clo_ptr_type _getc_21_closure_make () ;
static
ats_int_type _getc_21_clofun (ats_clo_ptr_type cloptr) ;
static
ats_int_type aux_23 (ats_ptr_type env0, ats_ptr_type env1, ats_ref_type arg0, ats_ref_type arg1, ats_int_type arg2) ;
static
ats_clo_ptr_type aux_23_closure_make (ats_ptr_type env0, ats_ptr_type env1) ;
static
ats_int_type aux_23_clofun (ats_clo_ptr_type cloptr, ats_ref_type arg0, ats_ref_type arg1, ats_int_type arg2) ;

/* partial value template declarations */
/* static temporary variable declarations */
// ATSstatic_void (statmp98) ;

/* external value variable declarations */

/* function implementations */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 1865(line=57, offs=25) -- 1877(line=57, offs=37)
*/
ATSglobaldec()
ats_int_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__position_line (ats_ptr_type arg0) {
/* local vardec */
ATSlocal (ats_int_type, tmp0) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__position_line:
tmp0 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg0), atslab_line) ;
return (tmp0) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__position_line] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 1902(line=58, offs=25) -- 1914(line=58, offs=37)
*/
ATSglobaldec()
ats_int_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__position_loff (ats_ptr_type arg0) {
/* local vardec */
ATSlocal (ats_int_type, tmp1) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__position_loff:
tmp1 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg0), atslab_loff) ;
return (tmp1) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__position_loff] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 1939(line=59, offs=25) -- 1951(line=59, offs=37)
*/
ATSglobaldec()
ats_lint_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__position_toff (ats_ptr_type arg0) {
/* local vardec */
ATSlocal (ats_lint_type, tmp2) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__position_toff:
tmp2 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg0), atslab_toff) ;
return (tmp2) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__position_toff] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 1984(line=61, offs=32) -- 2012(line=61, offs=60)
*/
ATSglobaldec()
ats_bool_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__lt_position_position (ats_ptr_type arg0, ats_ptr_type arg1) {
/* local vardec */
ATSlocal (ats_bool_type, tmp3) ;
ATSlocal (ats_lint_type, tmp4) ;
ATSlocal (ats_lint_type, tmp5) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__lt_position_position:
tmp4 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg0), atslab_toff) ;
tmp5 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg1), atslab_toff) ;
tmp3 = atspre_lt_lint_lint (tmp4, tmp5) ;
return (tmp3) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__lt_position_position] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 2045(line=62, offs=33) -- 2074(line=62, offs=62)
*/
ATSglobaldec()
ats_bool_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__lte_position_position (ats_ptr_type arg0, ats_ptr_type arg1) {
/* local vardec */
ATSlocal (ats_bool_type, tmp6) ;
ATSlocal (ats_lint_type, tmp7) ;
ATSlocal (ats_lint_type, tmp8) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__lte_position_position:
tmp7 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg0), atslab_toff) ;
tmp8 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg1), atslab_toff) ;
tmp6 = atspre_lte_lint_lint (tmp7, tmp8) ;
return (tmp6) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__lte_position_position] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 2106(line=63, offs=32) -- 2134(line=63, offs=60)
*/
ATSglobaldec()
ats_bool_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__eq_position_position (ats_ptr_type arg0, ats_ptr_type arg1) {
/* local vardec */
ATSlocal (ats_bool_type, tmp9) ;
ATSlocal (ats_lint_type, tmp10) ;
ATSlocal (ats_lint_type, tmp11) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__eq_position_position:
tmp10 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg0), atslab_toff) ;
tmp11 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg1), atslab_toff) ;
tmp9 = atspre_eq_lint_lint (tmp10, tmp11) ;
return (tmp9) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__eq_position_position] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 2167(line=64, offs=33) -- 2196(line=64, offs=62)
*/
ATSglobaldec()
ats_bool_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__neq_position_position (ats_ptr_type arg0, ats_ptr_type arg1) {
/* local vardec */
ATSlocal (ats_bool_type, tmp12) ;
ATSlocal (ats_lint_type, tmp13) ;
ATSlocal (ats_lint_type, tmp14) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__neq_position_position:
tmp13 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg0), atslab_toff) ;
tmp14 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg1), atslab_toff) ;
tmp12 = atspre_neq_lint_lint (tmp13, tmp14) ;
return (tmp12) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__neq_position_position] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 2356(line=70, offs=38) -- 2418(line=71, offs=42)
*/
ATSglobaldec()
ats_ptr_type
position_make_int_int_lint (ats_int_type arg0, ats_int_type arg1, ats_lint_type arg2) {
/* local vardec */
ATSlocal (ats_ptr_type, tmp15) ;

__ats_lab_position_make_int_int_lint:
tmp15 = ATS_MALLOC(sizeof(anairiats_rec_0)) ;
ats_selptrset_mac(anairiats_rec_0, tmp15, atslab_line, arg0) ;
ats_selptrset_mac(anairiats_rec_0, tmp15, atslab_loff, arg1) ;
ats_selptrset_mac(anairiats_rec_0, tmp15, atslab_toff, arg2) ;

return (tmp15) ;
} /* end of [position_make_int_int_lint] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 2446(line=73, offs=27) -- 2554(line=74, offs=78)
*/
ATSglobaldec()
ats_void_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__fprint_position (ats_ref_type arg0, ats_ptr_type arg1) {
/* local vardec */
// ATSlocal_void (tmp16) ;
ATSlocal (ats_lint_type, tmp17) ;
ATSlocal (ats_lint_type, tmp18) ;
ATSlocal (ats_int_type, tmp19) ;
ATSlocal (ats_int_type, tmp20) ;
ATSlocal (ats_int_type, tmp21) ;
ATSlocal (ats_int_type, tmp22) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__fprint_position:
tmp18 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg1), atslab_toff) ;
tmp17 = atspre_add_lint_lint (tmp18, 1L) ;
tmp20 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg1), atslab_line) ;
tmp19 = atspre_add_int_int (tmp20, 1) ;
tmp22 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_0, arg1), atslab_loff) ;
tmp21 = atspre_add_int_int (tmp22, 1) ;
/* tmp16 = */ atspre_fprintf_exn (arg0, ATSstrcst("%li(line=%i, offs=%i)"), tmp17, tmp19, tmp21) ;
return /* (tmp16) */ ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__fprint_position] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 2581(line=76, offs=26) -- 2621(line=76, offs=66)
*/
ATSglobaldec()
ats_void_type
lexing_print_position (ats_ptr_type arg0) {
/* local vardec */
// ATSlocal_void (tmp23) ;
ATSlocal (ats_ptr_type, tmp24) ;
ATSlocal (ats_ptr_type, tmp25) ;
// ATSlocal_void (tmp26) ;

__ats_lab_lexing_print_position:
tmp24 = atspre_stdout_get () ;
tmp25 = ats_selsin_mac(tmp24, atslab_1) ;
/* tmp26 = */ ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__fprint_position (tmp25, arg0) ;
/* tmp23 = */ atspre_stdout_view_set () ;
return /* (tmp23) */ ;
} /* end of [lexing_print_position] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 2647(line=77, offs=26) -- 2687(line=77, offs=66)
*/
ATSglobaldec()
ats_void_type
lexing_prerr_position (ats_ptr_type arg0) {
/* local vardec */
// ATSlocal_void (tmp27) ;
ATSlocal (ats_ptr_type, tmp28) ;
ATSlocal (ats_ptr_type, tmp29) ;
// ATSlocal_void (tmp30) ;

__ats_lab_lexing_prerr_position:
tmp28 = atspre_stderr_get () ;
tmp29 = ats_selsin_mac(tmp28, atslab_1) ;
/* tmp30 = */ ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__fprint_position (tmp29, arg0) ;
/* tmp27 = */ atspre_stderr_view_set () ;
return /* (tmp27) */ ;
} /* end of [lexing_prerr_position] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 2890(line=89, offs=23) -- 2931(line=89, offs=64)
*/
ATSglobaldec()
ats_void_type
lexing_infile_free (ats_ptr_type arg0) {
/* local vardec */
// ATSlocal_void (tmp31) ;
ATSlocal (ats_clo_ref_type, tmp32) ;

__ats_lab_lexing_infile_free:
tmp32 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_1, arg0), atslab_free) ;
/* tmp31 = */ ((ats_void_type(*)(ats_clo_ptr_type))(ats_closure_fun(tmp32))) (tmp32) ;
return /* (tmp31) */ ;
} /* end of [lexing_infile_free] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 2954(line=90, offs=23) -- 2995(line=90, offs=64)
*/
ATSglobaldec()
ats_int_type
lexing_infile_getc (ats_ptr_type arg0) {
/* local vardec */
ATSlocal (ats_int_type, tmp33) ;
ATSlocal (ats_clo_ref_type, tmp34) ;

__ats_lab_lexing_infile_getc:
tmp34 = ats_selbox_mac(ats_castptr_mac(anairiats_rec_1, arg0), atslab_getc) ;
tmp33 = ((ats_int_type(*)(ats_clo_ptr_type))(ats_closure_fun(tmp34))) (tmp34) ;
return (tmp33) ;
} /* end of [lexing_infile_getc] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 3247(line=102, offs=6) -- 3336(line=104, offs=6)
*/
ATSstaticdec()
ats_void_type
_free_14 (ats_ptr_type env0) {
/* local vardec */
// ATSlocal_void (tmp39) ;

__ats_lab__free_14:
/* tmp39 = */ atspre_ptr_free (env0) ;
return /* (tmp39) */ ;
} /* end of [_free_14] */

typedef struct {
ats_fun_ptr_type closure_fun ;
ats_ptr_type closure_env_0 ;
} _free_14_closure_type ;

ats_void_type
_free_14_clofun (ats_clo_ptr_type cloptr) {
_free_14 (((_free_14_closure_type*)cloptr)->closure_env_0) ; return ;
} /* end of function */

ATSinline()
ats_void_type
_free_14_closure_init (_free_14_closure_type *p_clo, ats_ptr_type env0) {
p_clo->closure_fun = (ats_fun_ptr_type)&_free_14_clofun ;
p_clo->closure_env_0 = env0 ;
return ;
} /* end of function */

ats_clo_ptr_type
_free_14_closure_make (ats_ptr_type env0) {
_free_14_closure_type *p_clo = ATS_MALLOC(sizeof(_free_14_closure_type)) ;
_free_14_closure_init (p_clo, env0) ;
return (ats_clo_ptr_type)p_clo ;
} /* end of function */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 3360(line=105, offs=6) -- 3590(line=112, offs=6)
*/
ATSstaticdec()
ats_int_type
_getc_15 (ats_ptr_type env0, ats_size_type env1, ats_ptr_type env2) {
/* local vardec */
ATSlocal (ats_int_type, tmp40) ;
ATSlocal (ats_size_type, tmp41) ;
ATSlocal (ats_int_type, tmp42) ;
ATSlocal (ats_bool_type, tmp43) ;
ATSlocal (ats_size_type, tmp44) ;
ATSlocal (ats_char_type, tmp45) ;

__ats_lab__getc_15:
tmp41 = ats_ptrget_mac(ats_size_type, env2) ;
tmp43 = atspre_lt_size1_size1 (tmp41, env1) ;
if (tmp43) {
tmp44 = atspre_add_size1_int1 (tmp41, 1) ;
ats_ptrget_mac(ats_size_type, env2) = tmp44 ;
tmp45 = atspre_string_get_char_at (env0, tmp41) ;
tmp42 = atspre_int_of_char (tmp45) ;
} else {
tmp42 = -1 ;
} /* end of [if] */
tmp40 = tmp42 ;
return (tmp40) ;
} /* end of [_getc_15] */

typedef struct {
ats_fun_ptr_type closure_fun ;
ats_ptr_type closure_env_0 ;
ats_size_type closure_env_1 ;
ats_ptr_type closure_env_2 ;
} _getc_15_closure_type ;

ats_int_type
_getc_15_clofun (ats_clo_ptr_type cloptr) {
return _getc_15 (((_getc_15_closure_type*)cloptr)->closure_env_0, ((_getc_15_closure_type*)cloptr)->closure_env_1, ((_getc_15_closure_type*)cloptr)->closure_env_2) ;
} /* end of function */

ATSinline()
ats_void_type
_getc_15_closure_init (_getc_15_closure_type *p_clo, ats_ptr_type env0, ats_size_type env1, ats_ptr_type env2) {
p_clo->closure_fun = (ats_fun_ptr_type)&_getc_15_clofun ;
p_clo->closure_env_0 = env0 ;
p_clo->closure_env_1 = env1 ;
p_clo->closure_env_2 = env2 ;
return ;
} /* end of function */

ats_clo_ptr_type
_getc_15_closure_make (ats_ptr_type env0, ats_size_type env1, ats_ptr_type env2) {
_getc_15_closure_type *p_clo = ATS_MALLOC(sizeof(_getc_15_closure_type)) ;
_getc_15_closure_init (p_clo, env0, env1, env2) ;
return (ats_clo_ptr_type)p_clo ;
} /* end of function */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 3030(line=95, offs=20) -- 3713(line=116, offs=4)
*/
ATSglobaldec()
ats_ptr_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__infile_make_string (ats_ptr_type arg0) {
/* local vardec */
ATSlocal (ats_ptr_type, tmp35) ;
ATSlocal (ats_size_type, tmp36) ;
ATSlocal (ats_ptr_type, tmp37) ;
ATSlocal (ats_ptr_type, tmp38) ;
ATSlocal (ats_size_type, tmp46) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__infile_make_string:
tmp36 = atspre_string_length (ats_castfn_mac(ats_ptr_type, arg0)) ;
tmp37 = atspre_ptr_alloc_tsz (sizeof(ats_size_type)) ;
tmp38 = ats_selsin_mac(tmp37, atslab_2) ;
tmp46 = atspre_size1_of_int1 (0) ;
ats_ptrget_mac(ats_size_type, tmp38) = tmp46 ;
tmp35 = ATS_MALLOC(sizeof(anairiats_rec_1)) ;
ats_selptrset_mac(anairiats_rec_1, tmp35, atslab_free, _free_14_closure_make (tmp38)) ;
ats_selptrset_mac(anairiats_rec_1, tmp35, atslab_getc, _getc_15_closure_make (ats_castfn_mac(ats_ptr_type, arg0), tmp36, tmp38)) ;

return (tmp35) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__infile_make_string] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 4159(line=136, offs=6) -- 4230(line=136, offs=77)
*/
ATSstaticdec()
ats_void_type
_free_17 (ats_ptr_type env0) {
/* local vardec */
// ATSlocal_void (tmp48) ;

__ats_lab__free_17:
/* tmp48 = */ atslib_fclose_exn (env0) ;
return /* (tmp48) */ ;
} /* end of [_free_17] */

typedef struct {
ats_fun_ptr_type closure_fun ;
ats_ptr_type closure_env_0 ;
} _free_17_closure_type ;

ats_void_type
_free_17_clofun (ats_clo_ptr_type cloptr) {
_free_17 (((_free_17_closure_type*)cloptr)->closure_env_0) ; return ;
} /* end of function */

ATSinline()
ats_void_type
_free_17_closure_init (_free_17_closure_type *p_clo, ats_ptr_type env0) {
p_clo->closure_fun = (ats_fun_ptr_type)&_free_17_clofun ;
p_clo->closure_env_0 = env0 ;
return ;
} /* end of function */

ats_clo_ptr_type
_free_17_closure_make (ats_ptr_type env0) {
_free_17_closure_type *p_clo = ATS_MALLOC(sizeof(_free_17_closure_type)) ;
_free_17_closure_init (p_clo, env0) ;
return (ats_clo_ptr_type)p_clo ;
} /* end of function */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 4236(line=137, offs=6) -- 4307(line=137, offs=77)
*/
ATSstaticdec()
ats_int_type
_getc_18 (ats_ptr_type env0) {
/* local vardec */
ATSlocal (ats_int_type, tmp49) ;

__ats_lab__getc_18:
tmp49 = atslib_fgetc_err (env0) ;
return (tmp49) ;
} /* end of [_getc_18] */

typedef struct {
ats_fun_ptr_type closure_fun ;
ats_ptr_type closure_env_0 ;
} _getc_18_closure_type ;

ats_int_type
_getc_18_clofun (ats_clo_ptr_type cloptr) {
return _getc_18 (((_getc_18_closure_type*)cloptr)->closure_env_0) ;
} /* end of function */

ATSinline()
ats_void_type
_getc_18_closure_init (_getc_18_closure_type *p_clo, ats_ptr_type env0) {
p_clo->closure_fun = (ats_fun_ptr_type)&_getc_18_clofun ;
p_clo->closure_env_0 = env0 ;
return ;
} /* end of function */

ats_clo_ptr_type
_getc_18_closure_make (ats_ptr_type env0) {
_getc_18_closure_type *p_clo = ATS_MALLOC(sizeof(_getc_18_closure_type)) ;
_getc_18_closure_init (p_clo, env0) ;
return (ats_clo_ptr_type)p_clo ;
} /* end of function */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 4100(line=134, offs=11) -- 4366(line=140, offs=4)
*/
ATSglobaldec()
ats_ptr_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__infile_make_file (ats_ptr_type arg0) {
/* local vardec */
ATSlocal (ats_ptr_type, tmp47) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__infile_make_file:
tmp47 = ATS_MALLOC(sizeof(anairiats_rec_1)) ;
ats_selptrset_mac(anairiats_rec_1, tmp47, atslab_free, _free_17_closure_make (arg0)) ;
ats_selptrset_mac(anairiats_rec_1, tmp47, atslab_getc, _getc_18_closure_make (arg0)) ;

return (tmp47) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__infile_make_file] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 4460(line=145, offs=6) -- 4550(line=147, offs=6)
*/
ATSstaticdec()
ats_void_type
_free_20 () {
/* local vardec */
// ATSlocal_void (tmp51) ;

__ats_lab__free_20:
return /* (tmp51) */ ;
} /* end of [_free_20] */

typedef struct {
ats_fun_ptr_type closure_fun ;
} _free_20_closure_type ;

ats_void_type
_free_20_clofun (ats_clo_ptr_type cloptr) {
_free_20 () ; return ;
} /* end of function */

ATSinline()
ats_void_type
_free_20_closure_init (_free_20_closure_type *p_clo) {
p_clo->closure_fun = (ats_fun_ptr_type)&_free_20_clofun ;
return ;
} /* end of function */

ats_clo_ptr_type
_free_20_closure_make () {
_free_20_closure_type *p_clo = ATS_MALLOC(sizeof(_free_20_closure_type)) ;
_free_20_closure_init (p_clo) ;
return (ats_clo_ptr_type)p_clo ;
} /* end of function */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 4556(line=148, offs=6) -- 4608(line=148, offs=58)
*/
ATSstaticdec()
ats_int_type
_getc_21 () {
/* local vardec */
ATSlocal (ats_int_type, tmp52) ;

__ats_lab__getc_21:
tmp52 = atslib_getchar () ;
return (tmp52) ;
} /* end of [_getc_21] */

typedef struct {
ats_fun_ptr_type closure_fun ;
} _getc_21_closure_type ;

ats_int_type
_getc_21_clofun (ats_clo_ptr_type cloptr) {
return _getc_21 () ;
} /* end of function */

ATSinline()
ats_void_type
_getc_21_closure_init (_getc_21_closure_type *p_clo) {
p_clo->closure_fun = (ats_fun_ptr_type)&_getc_21_clofun ;
return ;
} /* end of function */

ats_clo_ptr_type
_getc_21_closure_make () {
_getc_21_closure_type *p_clo = ATS_MALLOC(sizeof(_getc_21_closure_type)) ;
_getc_21_closure_init (p_clo) ;
return (ats_clo_ptr_type)p_clo ;
} /* end of function */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 4425(line=143, offs=19) -- 4671(line=151, offs=4)
*/
ATSglobaldec()
ats_ptr_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__infile_make_stdin () {
/* local vardec */
ATSlocal (ats_ptr_type, tmp50) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__infile_make_stdin:
tmp50 = ATS_MALLOC(sizeof(anairiats_rec_1)) ;
ats_selptrset_mac(anairiats_rec_1, tmp50, atslab_free, _free_20_closure_make ()) ;
ats_selptrset_mac(anairiats_rec_1, tmp50, atslab_getc, _getc_21_closure_make ()) ;

return (tmp50) ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__infile_make_stdin] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 4814(line=159, offs=5) -- 5658(line=185, offs=6)
*/
ATSstaticdec()
ats_int_type
aux_23 (ats_ptr_type env0, ats_ptr_type env1, ats_ref_type arg0, ats_ref_type arg1, ats_int_type arg2) {
/* local vardec */
ATSlocal (ats_int_type, tmp54) ;
ATSlocal (ats_bool_type, tmp55) ;
ATSlocal (ats_int_type, tmp56) ;
ATSlocal (ats_bool_type, tmp58) ;
// ATSlocal_void (tmp59) ;
ATSlocal (ats_int_type, tmp60) ;
ATSlocal (ats_int_type, tmp61) ;
// ATSlocal_void (tmp62) ;

__ats_lab_aux_23:
tmp55 = atspre_gt_int_int (arg2, 0) ;
if (tmp55) {
tmp56 = ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__accept_table_get (env1, arg2) ;
tmp58 = atspre_gt_int_int (tmp56, 0) ;
if (tmp58) {
/* tmp59 = */ lexbuf_lstpos_set (arg0) ;
ats_ptrget_mac(ats_int_type, arg1) = tmp56 ;
} else {
/* empty */
} /* end of [if] */
tmp60 = lexbuf_char_next (arg0) ;
tmp61 = ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__transition_table_get (env0, arg2, tmp60) ;
arg0 = arg0 ;
arg1 = arg1 ;
arg2 = tmp61 ;
goto __ats_lab_aux_23 ; // tail call
} else {
/* tmp62 = */ lexbuf_curpos_set (arg0) ;
tmp54 = ats_ptrget_mac(ats_int_type, arg1) ;
} /* end of [if] */
return (tmp54) ;
} /* end of [aux_23] */

typedef struct {
ats_fun_ptr_type closure_fun ;
ats_ptr_type closure_env_0 ;
ats_ptr_type closure_env_1 ;
} aux_23_closure_type ;

ats_int_type
aux_23_clofun (ats_clo_ptr_type cloptr, ats_ref_type arg0, ats_ref_type arg1, ats_int_type arg2) {
return aux_23 (((aux_23_closure_type*)cloptr)->closure_env_0, ((aux_23_closure_type*)cloptr)->closure_env_1, arg0, arg1, arg2) ;
} /* end of function */

ATSinline()
ats_void_type
aux_23_closure_init (aux_23_closure_type *p_clo, ats_ptr_type env0, ats_ptr_type env1) {
p_clo->closure_fun = (ats_fun_ptr_type)&aux_23_clofun ;
p_clo->closure_env_0 = env0 ;
p_clo->closure_env_1 = env1 ;
return ;
} /* end of function */

ats_clo_ptr_type
aux_23_closure_make (ats_ptr_type env0, ats_ptr_type env1) {
aux_23_closure_type *p_clo = ATS_MALLOC(sizeof(aux_23_closure_type)) ;
aux_23_closure_init (p_clo, env0, env1) ;
return (ats_clo_ptr_type)p_clo ;
} /* end of function */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 4778(line=157, offs=32) -- 5753(line=191, offs=4)
*/
ATSglobaldec()
ats_int_type
lexing_engine_lexbuf (ats_ref_type arg0, ats_ptr_type arg1, ats_ptr_type arg2) {
/* local vardec */
ATSlocal (ats_int_type, tmp53) ;
ATSlocal (ats_int_type, tmp63) ;
// ATSlocal_void (tmp64) ;

__ats_lab_lexing_engine_lexbuf:
/* ats_int_type tmp63 ; */
tmp63 = 0 ;
/* tmp64 = */ lexbuf_fstpos_set (arg0) ;
tmp53 = aux_23 (arg1, arg2, arg0, (&tmp63), 1) ;
return (tmp53) ;
} /* end of [lexing_engine_lexbuf] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 5812(line=193, offs=25) -- 6004(line=198, offs=4)
*/
ATSglobaldec()
ats_int_type
lexing_engine (ats_ptr_type arg0, ats_ptr_type arg1) {
/* local vardec */
ATSlocal (ats_int_type, tmp65) ;
ATSlocal (ats_ptr_type, tmp66) ;
ATSlocal (ats_ptr_type, tmp67) ;
ATSlocal (ats_int_type, tmp68) ;
// ATSlocal_void (tmp69) ;

__ats_lab_lexing_engine:
tmp66 = lexing_lexbuf_get () ;
tmp67 = ats_selsin_mac(tmp66, atslab_1) ;
tmp68 = lexing_engine_lexbuf (tmp67, arg0, arg1) ;
/* tmp69 = */ lexing_lexbuf_set (tmp67) ;
tmp65 = tmp68 ;
return (tmp65) ;
} /* end of [lexing_engine] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 6074(line=202, offs=22) -- 6225(line=207, offs=4)
*/
ATSglobaldec()
ats_char_type
lexeme_get (ats_int_type arg0) {
/* local vardec */
ATSlocal (ats_char_type, tmp70) ;
ATSlocal (ats_ptr_type, tmp71) ;
ATSlocal (ats_ptr_type, tmp72) ;
ATSlocal (ats_char_type, tmp73) ;
// ATSlocal_void (tmp74) ;

__ats_lab_lexeme_get:
tmp71 = lexing_lexbuf_get () ;
tmp72 = ats_selsin_mac(tmp71, atslab_1) ;
tmp73 = lexeme_get_lexbuf (tmp72, arg0) ;
/* tmp74 = */ lexing_lexbuf_set (tmp72) ;
tmp70 = tmp73 ;
return (tmp70) ;
} /* end of [lexeme_get] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 6271(line=209, offs=22) -- 6426(line=214, offs=4)
*/
ATSglobaldec()
ats_void_type
lexeme_set (ats_int_type arg0, ats_char_type arg1) {
/* local vardec */
// ATSlocal_void (tmp75) ;
ATSlocal (ats_ptr_type, tmp76) ;
ATSlocal (ats_ptr_type, tmp77) ;
// ATSlocal_void (tmp78) ;

__ats_lab_lexeme_set:
tmp76 = lexing_lexbuf_get () ;
tmp77 = ats_selsin_mac(tmp76, atslab_1) ;
/* tmp78 = */ lexeme_set_lexbuf (tmp77, arg0, arg1) ;
/* tmp75 = */ lexing_lexbuf_set (tmp77) ;
return /* (tmp75) */ ;
} /* end of [lexeme_set] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 6475(line=216, offs=25) -- 6625(line=221, offs=4)
*/
ATSglobaldec()
ats_ptr_type
lexeme_string () {
/* local vardec */
ATSlocal (ats_ptr_type, tmp79) ;
ATSlocal (ats_ptr_type, tmp80) ;
ATSlocal (ats_ptr_type, tmp81) ;
ATSlocal (ats_ptr_type, tmp82) ;
// ATSlocal_void (tmp83) ;

__ats_lab_lexeme_string:
tmp80 = lexing_lexbuf_get () ;
tmp81 = ats_selsin_mac(tmp80, atslab_1) ;
tmp82 = lexeme_string_lexbuf (tmp81) ;
/* tmp83 = */ lexing_lexbuf_set (tmp81) ;
tmp79 = tmp82 ;
return (tmp79) ;
} /* end of [lexeme_string] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 6675(line=223, offs=23) -- 6835(line=228, offs=4)
*/
ATSglobaldec()
ats_lint_type
lexeme_lint (ats_int_type arg0) {
/* local vardec */
ATSlocal (ats_lint_type, tmp84) ;
ATSlocal (ats_ptr_type, tmp85) ;
ATSlocal (ats_ptr_type, tmp86) ;
ATSlocal (ats_lint_type, tmp87) ;
// ATSlocal_void (tmp88) ;

__ats_lab_lexeme_lint:
tmp85 = lexing_lexbuf_get () ;
tmp86 = ats_selsin_mac(tmp85, atslab_1) ;
tmp87 = lexeme_lint_lexbuf (tmp86, arg0) ;
/* tmp88 = */ lexing_lexbuf_set (tmp86) ;
tmp84 = tmp87 ;
return (tmp84) ;
} /* end of [lexeme_lint] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 6970(line=238, offs=22) -- 7082(line=242, offs=4)
*/
ATSglobaldec()
ats_int_type
lexeme_int (ats_int_type arg0) {
/* local vardec */
ATSlocal (ats_int_type, tmp89) ;
ATSlocal (ats_lint_type, tmp90) ;

__ats_lab_lexeme_int:
tmp90 = lexeme_lint (arg0) ;
tmp89 = ats_int_of_lint (tmp90) ;
return (tmp89) ;
} /* end of [lexeme_int] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 7135(line=246, offs=25) -- 7278(line=251, offs=4)
*/
ATSglobaldec()
ats_bool_type
lexing_is_eof () {
/* local vardec */
ATSlocal (ats_bool_type, tmp91) ;
ATSlocal (ats_ptr_type, tmp92) ;
ATSlocal (ats_ptr_type, tmp93) ;
ATSlocal (ats_bool_type, tmp94) ;
// ATSlocal_void (tmp95) ;

__ats_lab_lexing_is_eof:
tmp92 = lexing_lexbuf_get () ;
tmp93 = ats_selsin_mac(tmp92, atslab_1) ;
tmp94 = lexbuf_is_eof (tmp93) ;
/* tmp95 = */ lexing_lexbuf_set (tmp93) ;
tmp91 = tmp94 ;
return (tmp91) ;
} /* end of [lexing_is_eof] */

/*
// /home/hwxi/Research/ATS-Anairiats/src/libats_lex_lexing.dats: 7349(line=255, offs=24) -- 7381(line=255, offs=56)
*/
ATSglobaldec()
ats_varet_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__lexing_error () {
/* local vardec */
// ATSlocal_void (tmp96) ;
ATSlocal (ats_ptr_type, tmp97) ;

__ats_lab_ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__lexing_error:
tmp97 = (ats_sum_ptr_type)(&ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__LexingErrorException) ;
/* tmp96 = */ ats_raise_exn (tmp97) ;
return /* (tmp96) */ ;
} /* end of [ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__lexing_error] */

/* static load function */

extern ats_void_type ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__staload (void) ;

ats_void_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2edats__staload () {
static int ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2edats__staload_flag = 0 ;
if (ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2edats__staload_flag) return ;
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2edats__staload_flag = 1 ;

ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2esats__staload () ;

return ;
} /* staload function */

/* dynamic load function */

// dynload flag declaration
extern ats_int_type ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2edats__dynload_flag ;

ats_void_type
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2edats__dynload () {
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2edats__dynload_flag = 1 ;
ATS_2d0_2e2_2e12_2src_2libats_lex_lexing_2edats__staload () ;

#ifdef _ATS_PROOFCHECK
ATS_2d0_2e2_2e12_2prelude_2basics_dyn_2esats__file_mode_lte_w_w_prfck () ;
#endif /* _ATS_PROOFCHECK */

/* marking static variables for GC */

/* marking external values for GC */

/* code for dynamic loading */
/* statmp98 = */ lexing_lexbuf_markroot () ;
return ;
} /* end of [dynload function] */

/* external codes at mid */
/* external codes at bot */


typedef
struct {
  unsigned char *buf_ptr ;
  int buf_size ;
  ats_ptr_type infile ;
  int fstpos ;
  int fstpos_line ; // line number
  int fstpos_loff ; // line offset
  long int fstpos_toff ; // total offset
  int lstpos ;
  int lstpos_line ; // line number
  int lstpos_loff ; // line offset
  long int lstpos_toff ; // total offset
  int curpos ;
  int curpos_line ; // line number
  int curpos_loff ; // line offset
  long int curpos_toff ; // total offset
  int endpos ;
} lexbuf ;

//

ats_ptr_type
lexbuf_fstpos_get (
  ats_ptr_type lxbf0
) {
  lexbuf *lxbf = (lexbuf *)lxbf0 ;
  return position_make_int_int_lint
    (lxbf->fstpos_line, lxbf->fstpos_loff, lxbf->fstpos_toff) ;
}

ats_void_type
lexbuf_fstpos_set (
  ats_ptr_type lxbf0
) {
  lexbuf *lxbf = (lexbuf *)lxbf0 ;
  lxbf->fstpos = lxbf->curpos ;
  lxbf->fstpos_line = lxbf->curpos_line ;
  lxbf->fstpos_loff = lxbf->curpos_loff ;
  lxbf->fstpos_toff = lxbf->curpos_toff ;
  return ;
}

//

ats_ptr_type
lexbuf_lstpos_get (
  ats_ptr_type lxbf0
) {
  lexbuf *lxbf = (lexbuf *)lxbf0 ;
  return position_make_int_int_lint
    (lxbf->lstpos_line, lxbf->lstpos_loff, lxbf->lstpos_toff) ;
}

ats_void_type
lexbuf_lstpos_set (
  ats_ptr_type lxbf0
) {
  lexbuf *lxbf = (lexbuf *)lxbf0 ;
  lxbf->lstpos = lxbf->curpos ;
  lxbf->lstpos_line = lxbf->curpos_line ;
  lxbf->lstpos_loff = lxbf->curpos_loff ;
  lxbf->lstpos_toff = lxbf->curpos_toff ;
  return ;
}

//

ats_ptr_type
lexbuf_curpos_get (
  ats_ptr_type lxbf0
) {
  lexbuf *lxbf = (lexbuf *)lxbf0 ;
  return position_make_int_int_lint
    (lxbf->curpos_line, lxbf->curpos_loff, lxbf->curpos_toff) ;
}

ats_void_type
lexbuf_curpos_set (
  ats_ptr_type lxbf0
) {
  lexbuf *lxbf = (lexbuf *)lxbf0 ;
  lxbf->curpos = lxbf->lstpos ;
  lxbf->curpos_line = lxbf->lstpos_line ;
  lxbf->curpos_loff = lxbf->lstpos_loff ;
  lxbf->curpos_toff = lxbf->lstpos_toff ;
  return ;
}

//

ats_int_type
lexbuf_size_get (ats_ptr_type lxbf0) {
  int sz ; lexbuf *lxbf ;
  lxbf = (lexbuf *)lxbf0;
  sz = lxbf->lstpos - lxbf->fstpos ;
  if (sz < 0) { sz += lxbf->buf_size ; }
  return sz ;
}

/* ****** ****** */

#define BUF_SIZE 1024
#define BUF_RESIZE 256

/* ****** ****** */

ats_void_type
lexbuf_resize
  (lexbuf *lxbf) {
  int fstpos, curpos, lstpos, endpos ;
  int buf_size, buf_size_new ;
  unsigned char *buf_ptr, *buf_ptr_new;
/*
  fprintf (stdout, "lexbuf_resize: before: buf_size = %i\n", lxbf->buf_size) ;
  fprintf (stdout, "lexbuf_resize: before: fstpos = %i\n", lxbf->fstpos) ;
  fprintf (stdout, "lexbuf_resize: before: curpos = %i\n", lxbf->curpos) ;
  fprintf (stdout, "lexbuf_resize: before: lstpos = %i\n", lxbf->lstpos) ;
  fprintf (stdout, "lexbuf_resize: before: endpos = %i\n", lxbf->endpos) ;
*/
  buf_ptr = lxbf->buf_ptr ;
  buf_size = lxbf->buf_size ;
  fstpos = lxbf->fstpos ;
  endpos = lxbf->endpos ;

  buf_size_new = buf_size + buf_size ;
  buf_ptr_new = ATS_MALLOC (buf_size_new) ;

  lxbf->buf_ptr = buf_ptr_new ;
  lxbf->buf_size = buf_size_new ;

  lxbf->fstpos = 0 ;

  if (fstpos <= endpos) {
    memcpy(buf_ptr_new, buf_ptr+fstpos, endpos-fstpos) ;
    lxbf->endpos = endpos - fstpos ;
  } else {
    memcpy(buf_ptr_new, buf_ptr+fstpos, buf_size-fstpos) ;
    memcpy(buf_ptr_new+buf_size-fstpos, buf_ptr, endpos) ;
    lxbf->endpos = buf_size + endpos - fstpos ;
  } // end of [if]

  curpos = lxbf->curpos ;

  if (fstpos <= curpos) {
    lxbf->curpos = curpos - fstpos ;
  } else {
    lxbf->curpos = buf_size + curpos - fstpos ;
  }

  lstpos = lxbf->lstpos ;

  if (fstpos <= lstpos) {
    lxbf->lstpos = lstpos - fstpos ;
  } else {
    lxbf->lstpos = buf_size + lstpos - fstpos ;
  } // end of [if]

/*
  fprintf (stdout, "lexbuf_resize: after: buf_size = %i\n", lxbf->buf_size) ;
  fprintf (stdout, "lexbuf_resize: after: fstpos = %i\n", lxbf->fstpos) ;
  fprintf (stdout, "lexbuf_resize: after: curpos = %i\n", lxbf->curpos) ;
  fprintf (stdout, "lexbuf_resize: after: lstpos = %i\n", lxbf->lstpos) ;
  fprintf (stdout, "lexbuf_resize: after: endpos = %i\n", lxbf->endpos) ;
*/

  ATS_FREE (buf_ptr) ;
} /* end of [lexbuf_resize] */

ats_void_type
lexbuf_resize_if
  (lexbuf *lxbf) {
  int fstpos, endpos ;

/*
  fprintf (stdout, "lexbuf_resize_if: buf_size = %i\n", lxbf->buf_size) ;
  fprintf (stdout, "lexbuf_resize_if: fstpos = %i\n", lxbf->fstpos) ;
  fprintf (stdout, "lexbuf_resize_if: curpos = %i\n", lxbf->curpos) ;
  fprintf (stdout, "lexbuf_resize_if: lstpos = %i\n", lxbf->lstpos) ;
  fprintf (stdout, "lexbuf_resize_if: endpos = %i\n", lxbf->endpos) ;
*/

  fstpos = lxbf->fstpos ;
  endpos = lxbf->endpos ;

  if (fstpos <= endpos) {
    if (endpos - fstpos + BUF_RESIZE > lxbf->buf_size) {
      lexbuf_resize(lxbf) ;
    }
  } else {
    if (endpos + BUF_RESIZE >= fstpos) {
      lexbuf_resize (lxbf) ;
    }
  }
  return ;
} /* end of [lexbuf_resize_if] */

ats_void_type
lexbuf_refill (
  ats_ptr_type lxbf0
) {
  lexbuf *lxbf ;
  unsigned char *buf_ptr ;
  int c, fstpos, curpos, endpos ;

  lxbf = (lexbuf*)lxbf0 ;

  lexbuf_resize_if (lxbf) ;

  buf_ptr = lxbf->buf_ptr ;
  fstpos = lxbf->fstpos ;
  endpos = lxbf->endpos ;
/*
  fprintf (stdout, "lexbuf_refill: fstpos = %i\n", fstpos) ;
  fprintf (stdout, "lexbuf_refill: endpos = %i\n", endpos) ;
*/
  if (fstpos <= endpos) {
    while (endpos+1 < lxbf->buf_size) {
      c = lexing_infile_getc (lxbf->infile) ;
      if (c < 0) { lxbf->endpos = endpos ; return ; }
      buf_ptr[endpos] = c; ++endpos ;
    }

    if (fstpos == 0) { lxbf->endpos = endpos ; return ; }

    c = lexing_infile_getc (lxbf->infile) ;
    if (c < 0) { lxbf->endpos = endpos ; return ; }
    buf_ptr[endpos] = c; endpos = 0;
  } /* end of [if] */

  while (endpos+1 < fstpos) {
    c = lexing_infile_getc (lxbf->infile) ;
    if (c < 0) { lxbf->endpos = endpos ; return ; }
    buf_ptr[endpos] = c; ++endpos ;
  } /* end of [while] */

  lxbf->endpos = endpos ;
  return ;
} /* end of [lexbuf_refill] */

/* ****** ****** */

ats_void_type
lexbuf_curpos_next (
  lexbuf *lxbf, int c
) {
  int curpos1 = lxbf->curpos + 1 ;

  if (curpos1 < lxbf->buf_size) {
    lxbf->curpos = curpos1;
  } else {
    lxbf->curpos = 0;
  }

  if (c == '\n') {
    lxbf->curpos_line += 1; lxbf->curpos_loff = 0; lxbf->curpos_toff += 1 ;
  } else {
    lxbf->curpos_loff += 1 ; lxbf->curpos_toff += 1 ;
  }
  return ;
} /* end of [lexbuf_curpos_next] */

/* ****** ****** */

ats_int_type
lexbuf_char_next (
  ats_ptr_type lxbf0
) {
  lexbuf *lxbf ;
  unsigned char *buf_ptr ;
  int c, fstpos, curpos, endpos ;

  lxbf = (lexbuf*)lxbf0 ;

  buf_ptr = lxbf->buf_ptr ;
  curpos = lxbf->curpos ;
  endpos = lxbf->endpos ;

  if (curpos != endpos) {
    c = buf_ptr[curpos] ; lexbuf_curpos_next (lxbf, c); return c ;
  }

  lexbuf_refill (lxbf0) ;

  buf_ptr = lxbf->buf_ptr ;
  curpos = lxbf->curpos ;
  endpos = lxbf->endpos ;
/*
  fprintf (stdout, "lexbuf_char_next: refill: curpos = %i\n", curpos);
  fprintf (stdout, "lexbuf_char_next: refill: endpos = %i\n", endpos);
*/
  if (curpos != endpos) {
    c = buf_ptr[curpos] ; lexbuf_curpos_next (lxbf, c); return c ;
  }
  return -1 ; /* [-1] represents a special character */
} /* end of [lexbuf_char_next] */

/* ****** ****** */

ats_bool_type
lexbuf_is_eof (
  ats_ptr_type lxbf0
) {
  lexbuf *lxbf = (lexbuf*)lxbf0 ;

  if (lxbf->curpos != lxbf->endpos) return ats_false_bool ;

  lexbuf_refill (lxbf0) ;  

  if (lxbf->curpos != lxbf->endpos) {
    return ats_false_bool ;
  } else {
    return ats_true_bool ;
  } /* end of [if] */
} /* end of [lexbuf_is_eof] */

/* ****** ****** */

ats_ptr_type
lexing_fstpos_get () {
  ats_ptr_type pos ; lexbuf *lxbf ;
  lxbf = (lexbuf *)(lexing_lexbuf_get()) ;
  pos = lexbuf_fstpos_get (lxbf) ;
  lexing_lexbuf_set(lxbf) ;
  return pos;
}

ats_ptr_type
lexing_lstpos_get () {
  ats_ptr_type pos ; lexbuf *lxbf ;
  lxbf = (lexbuf *)(lexing_lexbuf_get()) ;
  pos = lexbuf_lstpos_get (lxbf) ;
  lexing_lexbuf_set(lxbf) ;
  return pos;
}

ats_ptr_type
lexing_curpos_get () {
  ats_ptr_type pos ; lexbuf *lxbf ;
  lxbf = (lexbuf *)(lexing_lexbuf_get()) ;
  pos = lexbuf_curpos_get (lxbf) ;
  lexing_lexbuf_set(lxbf) ;
  return pos;
}

/* ****** ****** */

ats_void_type
lexbuf_curpos_fprint (
  ats_ptr_type fil, lexbuf *lxbf
) {
  fprintf ((FILE *)fil, "%li(line=%i, offset=%i)",
    lxbf->curpos_toff+1, lxbf->curpos_line+1, lxbf->curpos_loff+1
  ) ;
  return ;
} /* end of [lexbuf_curpos_fprint] */

ats_void_type
lexing_curpos_prerr () {
  lexbuf *lxbf ;
  lxbf = (lexbuf *)(lexing_lexbuf_get()) ;
  lexbuf_curpos_fprint (stderr, lxbf) ;
  lexing_lexbuf_set(lxbf) ;
  return ;
}

/* ****** ****** */

ats_ptr_type
lexbuf_make_infile (
  ats_ptr_type infile
) {
  lexbuf *lxbf ;
  unsigned char *buf_ptr ;

  buf_ptr = ATS_MALLOC (BUF_SIZE) ;
  lxbf = ATS_MALLOC (sizeof(lexbuf)) ;
  lxbf->buf_ptr = buf_ptr ;
  lxbf->buf_size = BUF_SIZE ;
  lxbf->infile = infile ;

  lxbf->fstpos = 0 ;
  lxbf->fstpos_line = 0 ;
  lxbf->fstpos_loff = 0 ;
  lxbf->fstpos_toff = 0 ;

  lxbf->lstpos = 0 ;
  lxbf->lstpos_line = 0 ;
  lxbf->lstpos_loff = 0 ;
  lxbf->lstpos_toff = 0 ;

  lxbf->curpos = 0 ;
  lxbf->curpos_line = 0 ;
  lxbf->curpos_loff = 0 ;
  lxbf->curpos_toff = 0 ;

  lxbf->endpos = 0 ;
/*
  printf ("lexbuf_make_infile: lxbf = %p\n", lxbf) ;
*/
  return lxbf ;
} /* end of [lexbuf_make_infile] */

ats_void_type
lexbuf_free (ats_ptr_type lxbf0) {
  lexbuf *lxbf ;
  lxbf = (lexbuf*)lxbf0 ;

  lexing_infile_free (lxbf->infile) ;
  ATS_FREE (lxbf->buf_ptr) ;
  return ;
}

/* ****** ****** */

ats_char_type
lexeme_get_lexbuf (ats_ptr_type lxbf0, ats_int_type i) {
  int len, fstpos, lstpos, bufsz ;
  lexbuf *lxbf ;

  if (i < 0) {
    ats_exit_errmsg (
      1, "lexeme_get_lexbuf: index is out_of_bounds.\n"
    ) ;
  } /* end of [if] */

  lxbf = (lexbuf*)lxbf0 ;

  fstpos = lxbf->fstpos ;
  lstpos = lxbf->lstpos ;
  len = lstpos - fstpos ;
  bufsz = lxbf->buf_size ;
  if (len < 0) { len += bufsz ; }

  if (i > len) {
    ats_exit_errmsg (
      1, "lexeme_get_lexbuf: index is out_of_bounds.\n"
    ) ;
  } /* end of [if] */

  i = fstpos + i ;
  if (i >= bufsz) { i -= bufsz ; }

  return *((lxbf->buf_ptr) + i) ;
}

ats_void_type
lexeme_set_lexbuf (
  ats_ptr_type lxbf0
, ats_int_type i, ats_char_type c
) {
  int len, fstpos, lstpos, bufsz ;
  lexbuf *lxbf ;

  if (i < 0) { ats_exit_errmsg (
      1, (ats_ptr_type)"lexeme_set_lexbuf: index is out_of_bounds.\n"
    ) ;
  } /* end of [if] */

  lxbf = (lexbuf*)lxbf0 ;

  fstpos = lxbf->fstpos ;
  lstpos = lxbf->lstpos ;
  len = lstpos - fstpos ;
  bufsz = lxbf->buf_size ;
  if (len < 0) { len += bufsz ; }

  if (i > len) { ats_exit_errmsg (
      1, (ats_ptr_type)"lexeme_set_lexbuf: index is out_of_bounds.\n"
    ) ;
  } /* end of [if] */

  i = fstpos + i ; if (i >= bufsz) { i -= bufsz ; }

  *((lxbf->buf_ptr) + i) = c ;

  return ;
} /* end of [lexeme_set_lexbuf] */

/* ****** ****** */

ats_ptr_type
lexeme_string_lexbuf
  (ats_ptr_type lxbf0) {
  int len, fstpos, lstpos ;
  char *src, *dst0, *dst ;
  lexbuf *lxbf ;

  lxbf = (lexbuf*)lxbf0 ;
  fstpos = lxbf->fstpos ;
  lstpos = lxbf->lstpos ;
  len = lstpos - fstpos ;
  if (len < 0) { len += lxbf->buf_size ; }

  src = (lxbf->buf_ptr) + fstpos ;
  dst0 = ATS_MALLOC ((len + 1) * sizeof(char)) ;
  dst = dst0 ;

  if (lstpos < fstpos) {
    while (fstpos < lxbf->buf_size) {
      *dst = *src ; ++fstpos ; ++src ; ++dst ;
    }
    fstpos = 0 ; src = lxbf->buf_ptr ;
  } // end of [if]

  while (fstpos < lstpos) {
    *dst = *src ; ++fstpos ; ++src ; ++dst ;
  } // end of [while]

  *dst = '\000' ;

  return dst0 ;
} /* end of [lexeme_string_lexbuf] */

/* ****** ****** */

ats_lint_type
lexeme_lint_lexbuf (
  ats_ptr_type lxbf0
, ats_int_type base
) {
  int fstpos ; lexbuf *lxbf ;
  lxbf = (lexbuf*)lxbf0 ;
  fstpos = lxbf->fstpos ;
  return strtol ((lxbf->buf_ptr) + fstpos, (char**)0, base) ;
} /* end of [lexeme_lint_lexbuf] */

/* ****** ****** */

static ats_ptr_type the_lexbuf = (lexbuf*)0 ;

ats_void_type lexing_lexbuf_markroot () {
  ATS_GC_MARKROOT (&the_lexbuf, sizeof(ats_ptr_type)) ;
  return ;
}

static ats_int_type the_lexbuf_flag = 0 ;

ats_ptr_type lexing_lexbuf_get() {
  if (the_lexbuf_flag == 0) {
    ats_exit_errmsg (
      1, "[lexeme_get] failed: The default lexbuf is not set!\n"
    );
  }
  the_lexbuf_flag = 0 ;
  return the_lexbuf ;
}

ats_void_type
lexing_lexbuf_set(ats_ptr_type lxbf) {
  if (the_lexbuf_flag == 1) {
    ats_exit_errmsg (
      1, "[lexeme_set] failed: The default lexbuf is already set!\n"
    );
  }
  the_lexbuf_flag = 1 ;
  the_lexbuf = lxbf ;
/*
  printf ("lexing_lexbuf_set: lxbf = %p\n", lxbf) ;
*/
  return ;
}

ats_void_type lexing_lexbuf_free () {
  lexbuf_free (lexing_lexbuf_get ()) ; return ;
}



/* ****** ****** */

/* end of [/home/hwxi/Research/ATS-Anairiats/bootstrap1/libats_lex_lexing_dats.c] */
